version: '3.8'
# =============================================================================
# SISTEMA DISTRIBUIDO - ENTORNO DE PRUEBAS (MANUAL FAILOVER)

services:
  # ---------------------------------------------------------------------------
  # COORDINADOR 1 (Host: michell) -> Port 5000
  # ---------------------------------------------------------------------------
  coordinator1:
    image: search-engine:distributed
    hostname: coordinator1
    environment:
      - NODE_ROLE=coordinator
      - NODE_ID=coord-1
      - NODE_HOST=0.0.0.0
      - NODE_PORT=5000
      - ANNOUNCE_HOST=coordinator1
      # Gossip: Conoce a coordinator2
      - PEER_COORDINATORS=coordinator2:5000 
      - REPLICATION_FACTOR=3
      - LOG_LEVEL=INFO
    ports:
      - "5000:5000"
    networks:
      search-network:
        aliases:
          - coordinator
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.hostname == michell
      restart_policy:
        condition: on-failure
        delay: 120s

  # ---------------------------------------------------------------------------
  # COORDINADOR 2 (Host: eveliz) -> Port 5001
  # ---------------------------------------------------------------------------
  coordinator2:
    image: search-engine:distributed
    hostname: coordinator2
    environment:
      - NODE_ROLE=coordinator
      - NODE_ID=coord-2
      - NODE_HOST=0.0.0.0
      - NODE_PORT=5000
      - ANNOUNCE_HOST=coordinator2
      # Gossip: Conoce a coordinator1
      - PEER_COORDINATORS=coordinator1:5000
      - REPLICATION_FACTOR=3
      - LOG_LEVEL=INFO
    ports:
      # Mapeamos 5001 del host al 5000 del contenedor
      - "5001:5000"
    networks:
      search-network:
        aliases:
          - coordinator
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.hostname == eveliz
      restart_policy:
        condition: on-failure
        delay: 120s

  # ---------------------------------------------------------------------------
  # NODO PROCESAMIENTO 1 (Host: michell)
  # ---------------------------------------------------------------------------
  processing1:
    image: search-engine:distributed
    hostname: processing1
    environment:
      - NODE_ROLE=processing
      - NODE_ID=proc-1
      - NODE_HOST=0.0.0.0
      - NODE_PORT=5000
      - COORDINATOR_HOST=coordinator1
      - ANNOUNCE_HOST=processing1
      - AUTO_INDEX=true
      - INIT_FILES_PATH=/home/app/shared_files
      - INDEX_PATH=/home/app/shared_files
      - DATA_PATH=/home/app/data
      - LOG_LEVEL=INFO
    networks:
      - search-network
    volumes:
      # Cada nodo tiene su propio volumen de almacenamiento
      - processing1-data:/home/app/data
      # Volumen compartido solo para archivos iniciales de lectura
      - shared-files:/home/app/shared_files:ro
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.hostname == michell
      restart_policy:
        condition: on-failure
        delay: 120s
  # ---------------------------------------------------------------------------
  # NODO PROCESAMIENTO 2 (Host: eveliz)
  # ---------------------------------------------------------------------------
  processing2:
    image: search-engine:distributed
    hostname: processing2
    environment:
      - NODE_ROLE=processing
      - NODE_ID=proc-2
      - NODE_HOST=0.0.0.0
      - NODE_PORT=5000
      - COORDINATOR_HOST=coordinator2
      - ANNOUNCE_HOST=processing2
      - AUTO_INDEX=true
      - INIT_FILES_PATH=/home/app/shared_files
      - INDEX_PATH=/home/app/shared_files
      - DATA_PATH=/home/app/data
      - LOG_LEVEL=INFO
    networks:
      - search-network
    volumes:
      # Cada nodo tiene su propio volumen de almacenamiento
      - processing2-data:/home/app/data
      # Volumen compartido solo para archivos iniciales de lectura
      - shared-files:/home/app/shared_files:ro
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.hostname == eveliz
      restart_policy:
        condition: on-failure
        delay: 120s

networks:
  search-network:
    driver: overlay
    attachable: true

volumes:
  # Volumen compartido para archivos iniciales (solo lectura para nodos)
  shared-files:
    external: true
  # Vol√∫menes individuales para cada nodo de procesamiento
  processing1-data:
  processing2-data:
